# ============================================================================
# Azure DevOps Pipeline for mongo-express (PROD Environment)
# ============================================================================
# This pipeline builds and deploys the mongo-express MongoDB admin UI
# Deployment: mongo-express.prod.simetrix.ch
# ============================================================================

name: 'mongo-express-prod'

trigger:
  branches:
    include:
      - development

parameters:
  - name: branch
    displayName: 'Select a branch'
    type: string
    default: 'development'
    values:
      - development

  - name: agent
    displayName: 'Select an agent'
    type: string
    default: 'Default'
    values:
      - 'Default'

variables:
  - name: ENVIRONMENT
    value: 'prod'
  - name: DOCKER_BUILDKIT
    value: '1'

stages:
  - stage: Build
    displayName: 'build mongo-express prod'
    jobs:
      - deployment: BuildMongoExpress
        displayName: 'build mongo-express prod'
        environment: 'prod'
        pool:
          name: ${{ parameters.agent }}
        strategy:
          runOnce:
            deploy:
              steps:
                # ============================================================
                # Step 1: Generate Build Version (1.0.YYMMDDHHMM.F)
                # ============================================================
                - script: |
                    BUILD_VERSION="1.0.$(date -u +'%y')$(date -u +'%m')$(date -u +'%d')$(date -u +'%H')$(date -u +'%M').F"
                    echo "##vso[task.setvariable variable=BUILD_VERSION]$BUILD_VERSION"
                    echo "Build version: $BUILD_VERSION"
                  displayName: 'set build version'

                # ============================================================
                # Step 2: Checkout Repository
                # ============================================================
                - checkout: self
                  displayName: 'checkout mongo-express'
                  persistCredentials: true
                  clean: true
                  fetchDepth: 1

                # ============================================================
                # Step 3: Build Docker Image
                # ============================================================
                - script: |
                    export DOCKER_BUILDKIT=1
                    docker build \
                      --no-cache \
                      --tag simetrix.azurecr.io/mongo-express:$(BUILD_VERSION) \
                      --file Dockerfile \
                      .
                  displayName: 'build docker image without cache'
                  workingDirectory: '$(Build.SourcesDirectory)'
                  condition: succeeded()

                # ============================================================
                # Step 4: Push Docker Image to Azure Container Registry
                # ============================================================
                - script: |
                    docker push simetrix.azurecr.io/mongo-express:$(BUILD_VERSION)
                  displayName: 'push to registry'
                  condition: succeeded()

                # ============================================================
                # Step 5: Tag Release in mongo-express Repository
                # ============================================================
                - script: |
                    git config user.email "azure-pipelines@simetrix.ch"
                    git config user.name "Azure Pipelines"
                    git tag $(BUILD_VERSION) HEAD -a -m "mongo-express version: $(BUILD_VERSION)"
                    git push --tags
                  displayName: 'tag new version'
                  workingDirectory: '$(Build.SourcesDirectory)'
                  condition: succeeded()

                # ============================================================
                # Step 6: Summary
                # ============================================================
                - bash: |
                    echo "============================================"
                    echo "Build and Deployment Summary"
                    echo "============================================"
                    echo "Version: $(BUILD_VERSION)"
                    echo "Environment: PROD"
                    echo "Image: simetrix.azurecr.io/mongo-express:$(BUILD_VERSION)"
                    echo "FQDN: mongo-express.prod.simetrix.ch"
                    echo "============================================"
                  displayName: 'Build Summary'

# ============================================================================
# Azure DevOps Pipeline for mongo-express (PROD Environment)
# ============================================================================
# This pipeline builds and deploys the mongo-express MongoDB admin UI
# Deployment: mongo-express.prod.simetrix.ch
# ============================================================================

name: 'mongo-express-prod'

trigger:
  branches:
    include:
      - development

resources:
  repositories:
    - repository: mongo-express-deploy
      type: git
      name: mongo-express-deploy

parameters:
  - name: branch
    displayName: 'Select a branch'
    type: string
    default: 'development'
    values:
      - development

  - name: agent
    displayName: 'Select an agent'
    type: string
    default: 'Default'
    values:
      - 'Default'

variables:
  - name: ENVIRONMENT
    value: 'prod'
  - name: DOCKER_BUILDKIT
    value: '1'

stages:
  - stage: Build
    displayName: 'build mongo-express prod'
    jobs:
      - deployment: BuildMongoExpress
        displayName: 'build mongo-express prod'
        environment: 'prod'
        pool:
          name: ${{ parameters.agent }}
        strategy:
          runOnce:
            deploy:
              steps:
                # ============================================================
                # Step 1: Generate Build Version (1.0.YYMMDDHHMM.F)
                # ============================================================
                - script: |
                    BUILD_VERSION="1.0.$(date -u +'%y')$(date -u +'%m')$(date -u +'%d')$(date -u +'%H')$(date -u +'%M').F"
                    echo "##vso[task.setvariable variable=BUILD_VERSION]$BUILD_VERSION"
                    echo "Build version: $BUILD_VERSION"
                  displayName: 'set build version'

                # ============================================================
                # Step 2: Checkout Repository
                # ============================================================
                - checkout: self
                  displayName: 'checkout mongo-express'
                  persistCredentials: true
                  clean: true
                  fetchDepth: 1

                # ============================================================
                # Step 3: Build Docker Image
                # ============================================================
                - script: |
                    export DOCKER_BUILDKIT=1
                    docker build \
                      --no-cache \
                      --tag simetrix.azurecr.io/mongo-express:$(BUILD_VERSION) \
                      --file Dockerfile \
                      .
                  displayName: 'build docker image without cache'
                  workingDirectory: '$(Agent.BuildDirectory)/s/mongo-express'
                  condition: succeeded()

                # ============================================================
                # Step 4: Push Docker Image to Azure Container Registry
                # ============================================================
                - script: |
                    docker push simetrix.azurecr.io/mongo-express:$(BUILD_VERSION)
                  displayName: 'push to registry'
                  condition: succeeded()

                # ============================================================
                # Step 5: Checkout mongo-express-deploy repository
                # ============================================================
                - checkout: mongo-express-deploy
                  displayName: 'checkout mongo-express-deploy'
                  persistCredentials: true
                  clean: true
                  fetchDepth: 1
                  condition: succeeded()

                # ============================================================
                # Step 6: Update Deployment Inventory (mongo-express-deploy)
                # ============================================================
                - script: |
                    cd mongo-express-deploy
                    git config user.email "azure-pipelines@simetrix.ch"
                    git config user.name "Azure Pipelines"
                    git config pull.rebase true
                    git fetch origin master
                    git checkout -B master origin/master

                    VALUES_FILE="inventories/mongo-express/$(ENVIRONMENT)/values.yaml"

                    if [ ! -f "$VALUES_FILE" ]; then
                      echo "ERROR: values.yaml not found at $VALUES_FILE"
                      exit 1
                    fi

                    echo "Updating mongo-express version in $VALUES_FILE..."

                    # Update image version for mongo-express
                    sed -i "s|image: simetrix.azurecr.io/mongo-express:.*|image: simetrix.azurecr.io/mongo-express:$(BUILD_VERSION)|g" "$VALUES_FILE"

                    echo "Updated content:"
                    grep -A 2 "image: simetrix.azurecr.io/mongo-express" "$VALUES_FILE" || true

                    git add "$VALUES_FILE"
                    git commit -m "Updated mongo-express ($(ENVIRONMENT)) to new version: $(BUILD_VERSION)"
                    git pull --rebase origin master
                    git push origin master

                    echo "Successfully updated deployment inventory"
                  displayName: 'update inventory version (prod)'
                  condition: succeeded()

                # ============================================================
                # Step 7: Checkout mongo-express for tagging
                # ============================================================
                - checkout: self
                  displayName: 'checkout mongo-express for tagging'
                  persistCredentials: true
                  clean: true
                  fetchDepth: 1
                  condition: succeeded()

                # ============================================================
                # Step 8: Tag Release in mongo-express Repository
                # ============================================================
                - script: |
                    git config user.email "azure-pipelines@simetrix.ch"
                    git config user.name "Azure Pipelines"
                    git tag $(BUILD_VERSION) HEAD -a -m "mongo-express version: $(BUILD_VERSION)"
                    git push --tags
                  displayName: 'tag new version'
                  workingDirectory: '$(Agent.BuildDirectory)/s/mongo-express'
                  condition: succeeded()

                # ============================================================
                # Step 9: Summary
                # ============================================================
                - bash: |
                    echo "============================================"
                    echo "Build and Deployment Summary"
                    echo "============================================"
                    echo "Version: $(BUILD_VERSION)"
                    echo "Environment: PROD"
                    echo "Image: simetrix.azurecr.io/mongo-express:$(BUILD_VERSION)"
                    echo "FQDN: mongo-express.prod.simetrix.ch"
                    echo "============================================"
                  displayName: 'Build Summary'

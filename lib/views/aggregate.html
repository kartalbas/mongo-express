{% extends 'layout.html' %}

{% block title %}Aggregate - {{ collectionName }}{% endblock %}

{% block styles %}
<style>
  #pageTitle { display: none; }
  .stage-editor .cm-editor { min-height: 80px; max-height: 200px; }
</style>
{% endblock %}

{% block breadcrumb %}
<li class="nav-item">
  <a class="nav-link px-1" href="{{ dbUrl }}">Database:</a>
</li>
<li class="nav-item">
  <a class="nav-link px-1" href="{{ dbUrl }}">{{ dbName }}</a>
</li>
<li class="nav-item">
  <a class="nav-link px-1" href="{{ collectionUrl }}">Collection:</a>
</li>
<li class="nav-item">
  <a class="nav-link px-1" href="{{ collectionUrl }}">{{ collectionName }}</a>
</li>
<li class="nav-item">
  <a class="nav-link disabled">Aggregation</a>
</li>
{% endblock %}

{% block content %}
<div x-data="pipeline()">
  <div class="d-flex align-items-center gap-2 mb-3">
    <h5 class="mb-0">Aggregation Pipeline</h5>
    <button class="btn btn-success btn-sm" @click="addStage()">
      <i data-lucide="plus" class="lucide"></i> Add Stage
    </button>
    <button class="btn btn-primary btn-sm ms-auto" @click="runPipeline()">
      <i data-lucide="search" class="lucide"></i> Run Pipeline
    </button>
    <button class="btn btn-outline-info btn-sm" @click="previewPipeline()">
      Preview
    </button>
  </div>

  <template x-for="(stage, index) in stages" :key="index">
    <div class="card mb-2">
      <div class="card-header py-1 px-2 d-flex align-items-center">
        <span class="badge bg-secondary me-2" x-text="'#' + (index + 1)"></span>
        <select class="form-select form-select-sm" style="width: auto;" x-model="stage.type" @change="updateStageTemplate(index)">
          <option value="$match">$match</option>
          <option value="$group">$group</option>
          <option value="$sort">$sort</option>
          <option value="$project">$project</option>
          <option value="$unwind">$unwind</option>
          <option value="$lookup">$lookup</option>
          <option value="$limit">$limit</option>
          <option value="$skip">$skip</option>
          <option value="$count">$count</option>
          <option value="$addFields">$addFields</option>
          <option value="$replaceRoot">$replaceRoot</option>
          <option value="$bucket">$bucket</option>
          <option value="$sample">$sample</option>
          <option value="$facet">$facet</option>
          <option value="$sortByCount">$sortByCount</option>
        </select>
        <button class="btn btn-outline-danger btn-sm ms-auto" @click="removeStage(index)">
          <i data-lucide="trash-2" class="lucide"></i>
        </button>
      </div>
      <div class="card-body py-2 px-2 stage-editor">
        <textarea :id="'stage-' + index" class="stage-textarea" x-ref="'stage' + index"></textarea>
      </div>
    </div>
  </template>

  <div id="aggregate-results" class="mt-3"></div>
</div>

<script>ME_SETTINGS.columns = {{ columns | dump | safe }};</script>
{% endblock %}

{% block scripts %}
<script src="{{ baseHref }}{{assets.codemirror.js}}"></script>
<script src="{{ baseHref }}{{assets.aggregate.js}}"></script>
{% endblock %}
